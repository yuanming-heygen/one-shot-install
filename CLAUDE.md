# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## What This Is

A single-shot shell environment installer that sets up a complete dev environment (zsh + Oh My Zsh + Powerlevel10k + tmux + nvm + uv) on Linux/macOS machines without requiring sudo or changing the login shell. Designed for shared servers where users can't run `chsh`.

## Key Files

- **`install.sh`** â€” The main installer script. All setup logic lives here.
- **`pack.sh`** â€” Bundles `install.sh` + config files into `install-standalone.sh` (a self-extracting script) via base64 encoding. Output is meant for `curl | bash` deployment.
- **`install-standalone.sh`** â€” Generated artifact from `pack.sh`. Do not edit directly.
- **`p10k.zsh`** â€” Powerlevel10k prompt configuration (generated by `p10k configure` wizard).
- **`tmux.config.local`** â€” oh-my-tmux local config overrides.

## Commands

```bash
# Run the installer locally
bash install.sh

# Dry-run to see what would change
bash install.sh --check

# Force re-run even if current version is already installed
bash install.sh --force

# Rebuild the standalone self-extracting script
bash pack.sh > install-standalone.sh
```

## Architecture

### install.sh Structure

The script follows a linear `main()` flow that runs each setup step in order. Version tracking (`INSTALL_VERSION` / `~/.config/shell/install-version`) prevents redundant re-runs.

Key design decisions:
- **No `chsh` needed**: bash stays as login shell; interactive bash sessions `exec` into `zsh -l` via a bashrc handoff block (`BASH_TO_ZSH_HANDOFF`).
- **No `curl | sh` patterns**: all remote scripts go through `download_and_run()` which downloads to a temp file first.
- **No sudo required**: `try_install_pkgs_no_password()` only runs package managers if passwordless sudo is available.
- **Idempotent blocks**: shell config modifications use marker comments (e.g., `BASHRC_ZSH_COMPAT_SHIM`, `UV_VENV_ALIASES`, `ZSH_TMUX_JEDITERM_FIX`) with `append_block_if_missing()` to prevent duplicate entries.
- **Cache symlinks**: heavy caches (`~/.cache/uv`, `~/.cache/pip`, `~/.conda`, etc.) are symlinked to `/local/$USER/` on machines with small home drives.
- **Config sourcing chain**: `~/.bash_profile` -> `~/.bashrc` -> `~/.config/shell/common.sh`; zsh also sources `~/.bashrc` (guarded by `ZSH_BASHRC_COMPAT`).

### pack.sh

Reads each file in `FILES` array, base64-encodes it into a shell variable, and emits a script that decodes + runs `install.sh`. If you add new config files, add them to the `FILES` array and add corresponding extraction lines in the `FOOTER` heredoc.

## Version Bumping

When making changes to `install.sh`, bump `INSTALL_VERSION` at the top of the file. This is how the installer detects whether a re-run is needed.

## Commit Messages

Follow the convention in `.github/COMMIT_CONVENTION.md`:

```
<emoji> [<scope>] <short description>

- <detail 1>
- <detail 2>
```

Common emojis: âœ¨ feat, ğŸ› fix, ğŸ“ docs, â™»ï¸ refactor, â¬†ï¸ dependency upgrade, ğŸ”§ config, ğŸ”¥ remove.
